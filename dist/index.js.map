{"version":3,"sources":["../index.js"],"names":["decoder","devConfig","process","env","DEVELOPMENT_CONFIG","apiaiOptions","hostname","DEVELOPMENT_HOST","path","apiAiService","sessionIds","Map","controller","slackbot","debug","json_file_store","bot","spawn","token","startRTM","numberOfSpots","playersInGame","gameInProgress","isDefined","obj","sendMessage","message","message_text","reply","err","hears","type","user","identity","id","text","indexOf","requestText","decode","replace","channel","messageType","event","botId","userId","has","set","v1","request","textRequest","sessionId","get","contexts","name","parameters","slack_user_id","slack_channel","on","response","result","responseText","fulfillment","speech","responseData","data","action","api","users","info","error","push","setTimeout","arrayContains","shuffle","forEach","username","updateNumberOfGamesPlayed","slack","resp","console","end","array","currentIndex","length","temporaryValue","randomIndex","Math","floor","random","storage","user_data","save","numberOfGamesPlayed","parseInt","toString","log","string","getAllPlayersNumberOfGames","all","all_user_data"],"mappings":"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","file":"index.js","sourcesContent":["'use strict';\n\nimport Botkit from \"botkit\";\nimport apiai from \"apiai\";\nimport uuid from \"node-uuid\";\nimport {XmlEntities as Entities} from \"html-entities\";\nimport {apiAiAccessToken, slackBotKey} from './secrets'\n\nconst decoder = new Entities();\n\nconst devConfig = process.env.DEVELOPMENT_CONFIG == 'true';\n\nconst apiaiOptions = {};\nif (devConfig) {\n    apiaiOptions.hostname = process.env.DEVELOPMENT_HOST;\n    apiaiOptions.path = \"/api/query\";\n}\n\nconst apiAiService = apiai(apiAiAccessToken, apiaiOptions);\n\nconst sessionIds = new Map();\n\nconst controller = Botkit.slackbot({\n    debug: false,\n    json_file_store: 'slackbot_storage'\n    //include \"log: false\" to disable logging\n});\n\nlet bot = controller.spawn({\n    token: slackBotKey\n}).startRTM();\n\n// Foos vars\nlet numberOfSpots = 4;\nlet playersInGame = [];\nlet gameInProgress = false;\n\n\nfunction isDefined(obj) {\n    if (typeof obj == 'undefined') {\n        return false;\n    }\n\n    if (!obj) {\n        return false;\n    }\n\n    return obj != null;\n}\n\nfunction sendMessage(message, message_text) {\n    try {\n        bot.reply(message, message_text);\n    } catch (err) {\n        bot.reply(message, err.message);\n    }\n}\n\n// Listen for direction messages and all mentions @foos-bot\ncontroller.hears(['.*'], ['direct_message', 'direct_mention', 'mention',], (bot, message) => {\n    try {\n        if (message.type == 'message') {\n            if (message.user == bot.identity.id) {\n                // message from bot can be skipped\n            }\n            else if (message.text.indexOf(\"<@U\") == 0 && message.text.indexOf(bot.identity.id) == -1) {\n                // skip other users direct mentions\n            }\n            else {\n\n                let requestText = decoder.decode(message.text);\n                requestText = requestText.replace(\"â€™\", \"'\");\n\n                let channel = message.channel;\n                let messageType = message.event;\n                let botId = '<@' + bot.identity.id + '>';\n                let userId = message.user;\n\n                if (requestText.indexOf(botId) > -1) {\n                    requestText = requestText.replace(botId, '');\n                }\n\n                if (!sessionIds.has(channel)) {\n                    sessionIds.set(channel, uuid.v1());\n                }\n\n                let request = apiAiService.textRequest(requestText,\n                    {\n                        sessionId: sessionIds.get(channel),\n                        contexts: [\n                            {\n                                name: \"generic\",\n                                parameters: {\n                                    slack_user_id: userId,\n                                    slack_channel: channel\n                                }\n                            }\n                        ]\n                    });\n\n                request.on('response', (response) => {\n\n                    if (isDefined(response.result)) {\n                        let responseText = response.result.fulfillment.speech;\n                        let responseData = response.result.fulfillment.data;\n                        let action = response.result.action;\n\n                        if (action === \"start_game\" || action === \"join_current_game\") {\n                            // start a new game if there isn't one in progress\n                            if (!gameInProgress) {\n                                gameInProgress = true;\n                                numberOfSpots = 3;\n                                playersInGame = [];\n                                sendMessage(message, responseText);\n\n                                // Add the person who sent the message to the game\n                                bot.api.users.info({user: message.user}, (error, response) => {\n                                    playersInGame.push(response.user.name);\n                                });\n\n                                // Start the timer - games only last 5 mins\n                                setTimeout(function () {\n                                    // let users know that time is running out\n                                    if (numberOfSpots > 0) {\n                                        sendMessage(message, '30 seconds to go and we need ' + numberOfSpots + ' more players...');\n                                    }\n                                    // close game if its been 5 mins and we didn't get enough players\n                                    setTimeout(function () {\n                                        if (gameInProgress) {\n                                            gameInProgress = false;\n                                            playersInGame = [];\n                                            sendMessage(message, 'Game closed before we got enough players');\n                                        }\n                                    }, 30000);\n                                }, 270000);\n                            }\n                            // Join the current game if there is one in progress\n                            else {\n                                bot.api.users.info({user: message.user}, (error, response) => {\n                                    // Don't let a user join the same game twice\n                                    if (arrayContains(response.user.name, playersInGame)) {\n                                        sendMessage(message, 'You are already in the game. You can\\'t join twice.');\n                                    }\n                                    else {\n                                        numberOfSpots--;\n                                        playersInGame.push(response.user.name);\n                                        if (numberOfSpots > 1) {\n                                            sendMessage(message, numberOfSpots + ' more spots to go...');\n                                        }\n                                        else if (numberOfSpots === 1) {\n                                            sendMessage(message, numberOfSpots + ' more spot to go! Ahhhhh!!!');\n                                        }\n                                        else if (numberOfSpots === 0) {\n                                            sendMessage(message, 'Awesome! All spots are filled!');\n                                            gameInProgress = false;\n                                            shuffle(playersInGame);\n                                            sendMessage(message, `Here is a random team assignment if you would like to use it? ${playersInGame[0]} & ${playersInGame[1]} VS ${playersInGame[2]} & ${playersInGame[3]}`);\n                                            // Save the number of games played to the local db\n                                            playersInGame.forEach((username) => {\n                                                updateNumberOfGamesPlayed(username);\n                                            })\n                                        }\n                                    }\n                                });\n                            }\n                        }\n\n                        // check the number of spots remaining\n                        else if (action === \"check_number_of_players_in_game\") {\n                            sendMessage(message, 'There are ' + numberOfSpots + ' remaining...');\n                        }\n\n                        // get help\n                        else if (action === \"get_help\") {\n                            sendMessage(message, responseText);\n                        }\n\n                        else if (isDefined(responseData) && isDefined(responseData.slack)) {\n                            try {\n                                bot.reply(message, responseData.slack);\n                            } catch (err) {\n                                bot.reply(message, err.message);\n                            }\n                        } else if (isDefined(responseText)) {\n                            bot.reply(message, responseText, (err, resp) => {\n                                if (err) {\n                                    console.error(err);\n                                }\n                            });\n                        }\n                    }\n\n                });\n\n                request.on('error', (error) => console.error(error));\n                request.end();\n            }\n        }\n    } catch\n        (err) {\n        console.error(err);\n    }\n});\n\n/**\n * Shuffles an array\n * @param array\n * @returns {*}\n */\nfunction shuffle(array) {\n    let currentIndex = array.length, temporaryValue, randomIndex;\n\n    // While there remain elements to shuffle...\n    while (0 !== currentIndex) {\n\n        // Pick a remaining element...\n        randomIndex = Math.floor(Math.random() * currentIndex);\n        currentIndex -= 1;\n\n        // And swap it with the current element.\n        temporaryValue = array[currentIndex];\n        array[currentIndex] = array[randomIndex];\n        array[randomIndex] = temporaryValue;\n    }\n\n    return array;\n}\n\n/**\n * Saves the number of games played to a local db\n * @param username\n */\nfunction updateNumberOfGamesPlayed(username) {\n    controller.storage.users.get(username, function (err, user_data) {\n        if (user_data) {\n            controller.storage.users.save({\n                id: username,\n                numberOfGamesPlayed: (parseInt(user_data.numberOfGamesPlayed, 10) + 1).toString()\n            }, function (err) {\n                if (err) {\n                    console.log(err, 'user data not saved');\n                }\n            });\n        }\n        else {\n            controller.storage.users.save({id: username, numberOfGamesPlayed: 1}, function (err) {\n                if (err) {\n                    console.log(err, 'user data not saved');\n                }\n            });\n        }\n    });\n}\n\n/**\n * Check if a string is in an array\n * @param string\n * @param array\n * @returns {boolean}\n */\nfunction arrayContains(string, array) {\n    return (array.indexOf(string) > -1);\n}\n\n/**\n * Returns the data about the number of games played for all users\n */\nfunction getAllPlayersNumberOfGames() {\n    controller.storage.users.all(function (err, all_user_data) {\n        return all_user_data;\n    });\n}"]}