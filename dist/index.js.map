{"version":3,"sources":["../index.js"],"names":["runWebServer","decoder","devConfig","process","env","DEVELOPMENT_CONFIG","apiaiOptions","hostname","DEVELOPMENT_HOST","path","apiAiService","sessionIds","Map","controller","slackbot","debug","json_file_store","bot","spawn","token","startRTM","numberOfSpots","playersInGame","numberOfChallengeSpots","challengers","gameInProgress","edInsults","isDefined","obj","sendMessage","message","messageText","reply","err","hears","attachmentMessage","attachments","title","callback_id","attachment_type","actions","type","user","identity","id","text","indexOf","requestText","decode","replace","channel","botId","userId","has","set","v1","request","textRequest","sessionId","get","contexts","name","parameters","slack_user_id","slack_channel","on","response","result","responseText","fulfillment","speech","responseData","data","action","api","users","info","error","push","randomInsultIndex","Math","floor","random","length","setTimeout","arrayContains","shuffle","forEach","username","updateNumberOfGamesPlayed","slack","resp","end","array","currentIndex","temporaryValue","randomIndex","storage","userData","save","numberOfGamesPlayed","parseInt","toString","string","getAllPlayersNumberOfGames","all","allUserData","index","readFileSync","createServer","method","processPost","writeHead","listen","callback","queryData","connection","destroy","post","parse"],"mappings":"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","file":"index.js","sourcesContent":["'use strict'\n\nimport apiai from 'apiai'\nimport Botkit from 'botkit'\nimport fs from 'fs'\nimport { XmlEntities as Entities } from 'html-entities'\nimport http from 'http'\nimport uuid from 'node-uuid'\nimport querystring from 'querystring'\nimport { apiAiAccessToken, slackBotKey } from './secrets'\n\n// start the web server\nrunWebServer()\n\nconst decoder = new Entities()\n\nconst devConfig = process.env.DEVELOPMENT_CONFIG === 'true'\n\nconst apiaiOptions = {}\nif (devConfig) {\n  apiaiOptions.hostname = process.env.DEVELOPMENT_HOST\n  apiaiOptions.path = '/api/query'\n}\n\nconst apiAiService = apiai(apiAiAccessToken, apiaiOptions)\n\nconst sessionIds = new Map()\n\nconst controller = Botkit.slackbot({\n  debug: false,\n  json_file_store: 'slackbot_storage'\n  // include \"log: false\" to disable logging\n})\n\nlet bot = controller.spawn({\n  token: slackBotKey\n}).startRTM()\n\n// Foos vars\nlet numberOfSpots = 4\nlet playersInGame = []\nlet numberOfChallengeSpots = 2\nlet challengers = []\nlet gameInProgress = false\nlet edInsults = [\n  '@edwardvincent Are you sure that is wise? :flushed:',\n  '@edwardvincent Are you sure? :flushed:',\n  '@edwardvincent Really?!! :flushed:',\n  '@edwardvincent When will you learn? :flushed:',\n  '@edwardvincent It just makes me sad :cry:'\n]\n\nfunction isDefined (obj) {\n  if (typeof obj === 'undefined') {\n    return false\n  }\n\n  if (!obj) {\n    return false\n  }\n\n  return obj !== null\n}\n\nfunction sendMessage (message, messageText) {\n  try {\n    bot.reply(message, messageText)\n  } catch (err) {\n    bot.reply(message, err.message)\n  }\n}\n\n// Listen for direction messages and all mentions @foos-bot\ncontroller.hears(['.*'], ['direct_message', 'direct_mention', 'mention'], (bot, message) => {\n  try {\n    let attachmentMessage = {\n      attachments: [\n        {\n          title: 'Do you want to interact with my buttons?',\n          callback_id: '123',\n          attachment_type: 'default',\n          actions: [\n            {\n              'name': 'yes',\n              'text': 'Yes',\n              'value': 'yes',\n              'type': 'button',\n            },\n            {\n              'name': 'no',\n              'text': 'No',\n              'value': 'no',\n              'type': 'button',\n            }\n          ]\n        }\n      ]\n    }\n    sendMessage(message, attachmentMessage)\n\n    if (message.type === 'message') {\n      if (message.user === bot.identity.id) {\n        // message from bot can be skipped\n      } else if (message.text.indexOf('<@U') === 0 && message.text.indexOf(bot.identity.id) === -1) {\n        // skip other users direct mentions\n      } else {\n        let requestText = decoder.decode(message.text)\n        requestText = requestText.replace('’', '\\'')\n\n        let channel = message.channel\n        let botId = '<@' + bot.identity.id + '>'\n        let userId = message.user\n\n        if (requestText.indexOf(botId) > -1) {\n          requestText = requestText.replace(botId, '')\n        }\n\n        if (!sessionIds.has(channel)) {\n          sessionIds.set(channel, uuid.v1())\n        }\n\n        let request = apiAiService.textRequest(requestText,\n          {\n            sessionId: sessionIds.get(channel),\n            contexts: [\n              {\n                name: 'generic',\n                parameters: {\n                  slack_user_id: userId,\n                  slack_channel: channel\n                }\n              }\n            ]\n          })\n\n        request.on('response', (response) => {\n          if (isDefined(response.result)) {\n            let responseText = response.result.fulfillment.speech\n            let responseData = response.result.fulfillment.data\n            let action = response.result.action\n\n            if (action === 'start_game' || action === 'join_current_game') {\n              // start a new game if there isn't one in progress\n              if (!gameInProgress) {\n                gameInProgress = true\n                numberOfSpots = 3\n                numberOfChallengeSpots = 2\n                playersInGame = []\n                sendMessage(message, responseText)\n\n                // Add the person who sent the message to the game\n                bot.api.users.info({user: message.user}, (error, response) => {\n                  if (error) {\n                    console.log(error)\n                  }\n                  playersInGame.push(response.user.name)\n\n                  // If user is ed mock him a little\n                  if (response.user.name === 'edwardvincent') {\n                    let randomInsultIndex = Math.floor(Math.random() * edInsults.length)\n                    sendMessage(message, edInsults[randomInsultIndex])\n                  }\n                })\n\n                // Start the timer - games only last 5 mins\n                setTimeout(function () {\n                  // let users know that time is running out\n                  if (numberOfSpots > 0) {\n                    sendMessage(message, '30 seconds to go and we need ' + numberOfSpots + ' more players... :timer_clock: :timer_clock:')\n                  }\n                  // close game if its been 5 mins and we didn't get enough players\n                  setTimeout(function () {\n                    if (gameInProgress) {\n                      gameInProgress = false\n                      playersInGame = []\n                      sendMessage(message, 'Game closed before we got enough players :cry:')\n                    }\n                  }, 30000)\n                }, 270000)\n              } else { // Join the current game if there is one in progress\n                bot.api.users.info({user: message.user}, (error, response) => {\n                  if (error) {\n                    console.log(error)\n                  }\n                  // Don't let a user join the same game twice\n                  if (arrayContains(response.user.name, playersInGame)) {\n                    sendMessage(message, 'You are already in the game. You can\\'t join twice. :no_entry_sign:')\n                  } else {\n                    numberOfSpots--\n                    playersInGame.push(response.user.name)\n                    if (numberOfSpots > 1) {\n                      sendMessage(message, numberOfSpots + ' more spots to go... :timer_clock:')\n                    } else if (numberOfSpots === 1) {\n                      sendMessage(message, numberOfSpots + ' more spot to go! Ahhhhh!!! :scream_cat:')\n                    } else if (numberOfSpots === 0) {\n                      sendMessage(message, 'Awesome! All spots are filled! :+1:')\n                      // Wait 30 seconds before allowing a new game to start so that we can catch users who were too slow\n                      setTimeout(function () {\n                        if (gameInProgress) {\n                          gameInProgress = false\n                        }\n                      }, 30000)\n                      shuffle(playersInGame)\n                      sendMessage(message, `Here is a random team assignment if you would like to use it?`)\n                      sendMessage(message, `:foos: _${playersInGame[0]}_ *&* _${playersInGame[1]}_`)\n                      sendMessage(message, `:vs:`)\n                      sendMessage(message, `:foos: _${playersInGame[2]}_ *&* _${playersInGame[3]}_`)\n                      // Save the number of games played to the local db\n                      playersInGame.forEach((username) => {\n                        updateNumberOfGamesPlayed(username)\n                      })\n                    } else { sendMessage(message, `:no_good: too slow! :turtle:`) }\n                  }\n                })\n              }\n            } else if (action === 'challenge_winners') { // challenge the winners of the last game\n              if (gameInProgress) {\n                if (numberOfSpots !== 0) {\n                  sendMessage(message, 'There is still space in the current game. Please join that instead of trying to challenge.')\n                } else if (numberOfChallengeSpots === 0) {\n                  sendMessage(message, 'Sorry, we already have 2 challengers')\n                } else {\n                  numberOfChallengeSpots--\n                  sendMessage(message, 'Ok great, you are in for the next game!')\n                }\n              } else {\n                sendMessage(message, 'Sorry there is no game in progress for you to challenge. Please be faster next time. The ability to challenge expires 30 seconds after the game is full')\n              }\n            } else if (action === 'check_number_of_players_in_game') { // check the number of spots remaining\n              sendMessage(message, 'There are ' + numberOfSpots + ' remaining...')\n            } else if (action === 'get_help') {\n              sendMessage(message, responseText)\n            } else if (isDefined(responseData) && isDefined(responseData.slack)) {\n              try {\n                bot.reply(message, responseData.slack)\n              } catch (err) {\n                bot.reply(message, err.message)\n              }\n            } else if (isDefined(responseText)) {\n              bot.reply(message, responseText, (err, resp) => {\n                if (err) {\n                  console.error(err)\n                }\n              })\n            }\n          }\n        })\n\n        request.on('error', (error) => console.error(error))\n        request.end()\n      }\n    }\n  } catch\n    (err) {\n    console.error(err)\n  }\n})\n\n/**\n * Shuffles an array\n * @param array\n * @returns {*}\n */\nfunction shuffle (array) {\n  let currentIndex = array.length\n  let temporaryValue\n  let randomIndex\n\n  // While there remain elements to shuffle...\n  while (currentIndex !== 0) {\n    // Pick a remaining element...\n    randomIndex = Math.floor(Math.random() * currentIndex)\n    currentIndex -= 1\n\n    // And swap it with the current element.\n    temporaryValue = array[currentIndex]\n    array[currentIndex] = array[randomIndex]\n    array[randomIndex] = temporaryValue\n  }\n\n  return array\n}\n\n/**\n * Saves the number of games played to a local db\n * @param username\n */\nfunction updateNumberOfGamesPlayed (username) {\n  controller.storage.users.get(username, function (error, userData) {\n    if (error) {\n      console.log(error)\n    }\n    if (userData) {\n      controller.storage.users.save({\n        id: username,\n        numberOfGamesPlayed: (parseInt(userData.numberOfGamesPlayed, 10) + 1).toString()\n      }, function (err) {\n        if (err) {\n          console.log(err, 'user data not saved')\n        }\n      })\n    } else {\n      controller.storage.users.save({id: username, numberOfGamesPlayed: 1}, function (err) {\n        if (err) {\n          console.log(err, 'user data not saved')\n        }\n      })\n    }\n  })\n}\n\n/**\n * Check if a string is in an array\n * @param string\n * @param array\n * @returns {boolean}\n */\nfunction arrayContains (string, array) {\n  return (array.indexOf(string) > -1)\n}\n\n/**\n * Returns the data about the number of games played for all users\n */\nfunction getAllPlayersNumberOfGames () {\n  controller.storage.users.all(function (error, allUserData) {\n    if (error) {\n      console.log(error)\n    }\n    return allUserData\n  })\n}\n\nfunction runWebServer () {\n  const index = fs.readFileSync('index.html')\n\n  http.createServer(function (request, response) {\n    if (request.method === 'POST') {\n      processPost(request, response, function () {\n        console.log(request.post)\n        // Use request.post here\n        response.writeHead(200, 'OK', {'Content-Type': 'text/plain'})\n        response.end()\n      })\n    } else {\n      response.writeHead(200, 'OK', {'Content-Type': 'text/plain'})\n      response.end(index)\n    }\n  }).listen(9615)\n}\n\nfunction processPost (request, response, callback) {\n  let queryData = ''\n  if (typeof callback !== 'function') return null\n\n  if (request.method === 'POST') {\n    request.on('data', function (data) {\n      queryData += data\n      if (queryData.length > 1e6) {\n        queryData = ''\n        response.writeHead(413, {'Content-Type': 'text/plain'}).end()\n        request.connection.destroy()\n      }\n    })\n\n    request.on('end', function () {\n      request.post = querystring.parse(queryData)\n      callback()\n    })\n  } else {\n    response.writeHead(405, {'Content-Type': 'text/plain'})\n    response.end()\n  }\n}\n"]}